# قواعد الظهور والإخفاء (Visibility Rules)

هدف هذا الملف: منع "الخلط" بين الصفات/الفروع، وضمان أن كل عنصر يظهر فقط عندما يكون ذلك **صحيحًا معماريًا**.

## 1) قواعد عامة

- عنصر في القائمة / زر / إجراء لا يظهر إلا إذا:
  1. المستخدم **مسجل دخول**.
  2. يوجد **orgId + branchId** نشطين في السياق.
  3. توجد **persona** نشطة.
  4. يملك المستخدم الصلاحية المطلوبة (Permission).

## 2) مصدر الحقيقة للصلاحيات

- الواجهة الأمامية **لا تستنتج** الصلاحيات.
- المصدر:
  - `/api/registry/modules` أو `/api/registry/nav` لتكوين القائمة.
  - `/api/ui/catalog` لتكوين صفحات المرحلة 3 وBlueprints.

## 3) مسار التعامل مع CONTEXT_REQUIRED

إذا رجع API خطأ `CONTEXT_REQUIRED`:
- أوقف أي محاولة لإعادة الطلب تلقائيًا.
- انقل المستخدم مباشرة إلى:
  - شاشة اختيار الفرع/الصفة.
- بعد النجاح: أعد تحميل:
  - `/api/registry/modules` + `/api/ui/catalog`.

## 4) قواعد خاصة بالأفعال الحساسة

أي فعل من القائمة التالية يجب أن يطلب "تأكيد" قبل التنفيذ:
- طباعة / توقيع / إرسال / اعتماد / ترحيل مالي / إقفال فترة.

### عقد التأكيد (Headers)
- الواجهة ترسل قبل الفعل:
  - `X-Confirm-Persona: <active_persona>`
  - `X-Confirm-Branch: <active_branchId>`

> التنفيذ الحالي يوفر Middleware جاهز للفرض لاحقًا على المسارات الحساسة.

## 5) منع UI من كشف صفحات ليست ضمن الاشتراك

حتى لو كان لدى المستخدم صلاحيات إدارية:
- لا تُظهر صفحات لمسار غير مفعّل بالاشتراك.
- المصدر:
  - `module.<key>.enabled` من settings.
  - أو العلم `enabled` القادم من `/api/registry/modules`.

## 6) حالات التحميل والتخزين المؤقت

- `/api/registry/version` و `meta.version` في `/api/ui/catalog` يمكن استخدامها للتخزين المؤقت.
- عند تغير أي منهما: يجب إعادة بناء القائمة والصفحات.
